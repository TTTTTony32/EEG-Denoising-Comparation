# EEG降噪脚本使用说明

本目录包含两个用于在测试集上进行降噪的脚本，可以输出完整的(2700,512)形状的numpy矩阵。

## 文件说明

1. **`denoise_test.py`** - 完整版降噪脚本，包含详细的错误处理和配置选项
2. **`simple_denoise.py`** - 简化版降噪脚本，更容易使用和修改

## 使用前准备

### 1. 确保数据文件存在
确保以下文件存在于正确位置：
```
./datasets/test_input.npy   # 测试集输入数据 (2700, 512)
./datasets/test_output.npy  # 测试集输出数据 (2700, 512)
```

### 2. 确保模型权重文件存在
确保训练好的模型权重文件存在，默认路径为：
```
./results/2024_01_11_15_DiR_4_EOG_pathch16_mini_seq32_hidden_dim512_layer_1_EMG/weight/best.pth
```

如果权重文件路径不同，请修改脚本中的 `weight_path` 变量。

## 使用方法

### 方法1：使用简化版脚本（推荐）
```bash
python simple_denoise.py
```

### 方法2：使用完整版脚本
```bash
python denoise_test.py
```

## 输出文件

脚本运行完成后会生成以下文件：

1. **`denoised_test_output.npy`** - 降噪后的numpy矩阵文件 (2700, 512)
2. **`denoised_test_output.txt`** - 降噪后的文本格式文件，便于查看

## 自定义配置

### 修改权重文件路径
在脚本中找到并修改 `weight_path` 变量：
```python
weight_path = "你的权重文件路径.pth"
```

### 修改输出文件路径
在脚本中找到并修改 `output_path` 变量：
```python
output_path = "你的输出文件路径.npy"
```

### 修改配置文件路径
如果需要使用不同的模型配置，修改 `config_path` 变量：
```python
config_path = "你的配置文件路径.yml"
```

## 脚本功能

1. **自动检测文件** - 检查权重文件和测试数据是否存在
2. **批量处理** - 使用DataLoader进行批量降噪处理
3. **进度显示** - 使用tqdm显示处理进度
4. **结果验证** - 确保输出形状与输入一致
5. **多格式保存** - 同时保存为.npy和.txt格式
6. **统计信息** - 显示输出数据的统计信息

## 注意事项

1. **内存使用** - 如果测试数据很大，确保有足够的内存
2. **GPU使用** - 脚本会自动检测并使用可用的GPU
3. **批次大小** - 批次大小在配置文件中设置，可根据GPU内存调整
4. **数据格式** - 输入数据应为numpy数组，形状为(2700, 512)

## 故障排除

### 常见错误及解决方案

1. **权重文件不存在**
   - 检查权重文件路径是否正确
   - 确保模型已经训练完成

2. **测试数据文件不存在**
   - 检查 `./datasets/` 目录下是否有 `test_input.npy` 和 `test_output.npy` 文件

3. **内存不足**
   - 减小配置文件中的 `batch_size` 参数
   - 关闭其他占用内存的程序

4. **CUDA内存不足**
   - 减小批次大小
   - 使用CPU模式（修改Accelerator配置）

## 示例输出

```
1. 加载配置文件...
2. 初始化模型...
3. 加载测试数据...
   测试数据形状: (2700, 512)
4. 开始降噪处理...
降噪进度: 100%|██████████| 3/3 [00:05<00:00,  1.67s/it]
5. 合并结果...
   输出形状: (2700, 512)
6. 保存结果...
   已保存到: ./denoised_test_output.npy
   已保存到: ./denoised_test_output.txt

✅ 降噪完成!
📊 输出形状: (2700, 512)
📈 统计信息:
   最小值: -0.123456
   最大值: 0.987654
   平均值: 0.001234
   标准差: 0.567890
``` 